==============================
 Message protocol description
==============================

Message description
===================

::

   +--------------------+
   |       MESSAGE      |
   +----------+---------+
   |  HEADER  | PAYLOAD |
   +----------+---------+
   0          8       N+8

+---------+--------------+------------------------------------------------------+
| Name    | Size (bytes) | Description                                          |
+=========+==============+======================================================+
| HEADER  | 8            | The message header, see :ref:`msg-header-desc`       |
+---------+--------------+------------------------------------------------------+
| PAYLOAD | N            | The message payload (could be empty)                 |
+---------+--------------+------------------------------------------------------+


.. _msg-header-desc:

Header description
==================

::

   +-----------------+
   |     HEADER      |
   +--------+--------+
   |   ID   |  SIZE  |
   +--------+--------+
   0        4        8

+---------+--------------+------------------------------------------------------+
| Name    | Size (bytes) | Description                                          |
+=========+==============+======================================================+
| ID      | 4            | The message id. Little-endian encoded                |
+---------+--------------+------------------------------------------------------+
| SIZE    | 4            | The payload size. Little-endian encoded              |
+---------+--------------+------------------------------------------------------+


Payload description
===================

The payload is a sequence of arguments without any padding between them.
Size of arguments depends on argument type. If the message has no arguments
there is no payload in it.

::

   +---------------------------+
   |          PAYLOAD          |
   +------+------+------+------+
   | ARG1 | ARG2 | ...  | ARGN |
   +------+------+------+------+
   0                           N


Argument description
====================

::

   +-----------------+
   |       ARG       |
   +--------+--------+
   |  TYPE  |  DATA  |
   +--------+--------+
   0        1      1+N

+---------+--------------+------------------------------------------------------+
| Name    | Size (bytes) | Description                                          |
+=========+==============+======================================================+
| TYPE    | 1            | The type of the argument. See :ref:`msg-arg-type`    |
+---------+--------------+------------------------------------------------------+
| DATA    | N            | The encoded argument.                                |
+---------+--------------+------------------------------------------------------+

.. _msg-arg-type:

Argument types
--------------

+---------+-------+--------------+----------------------------------------------+
| Name    | Value | Size (bytes) | Description                                  |
+=========+=======+==============+==============================================+
| UINT8   | 0x01  | 1            | 8-bits unsigned integer                      |
+---------+-------+--------------+----------------------------------------------+
| INT8    | 0x02  | 1            | 8-bits signed integer                        |
+---------+-------+--------------+----------------------------------------------+
| UINT16  | 0x03  | 2            | 16-bits unsigned integer, little-endian      |
+---------+-------+--------------+----------------------------------------------+
| INT16   | 0x04  | 2            | 16-bits signed integer, little-endian        |
+---------+-------+--------------+----------------------------------------------+
| UINT32  | 0x05  | 4            | 32-bits unsigned integer, little-endian      |
+---------+-------+--------------+----------------------------------------------+
| INT32   | 0x06  | 4            | 32-bits signed integer, little-endian        |
+---------+-------+--------------+----------------------------------------------+
| UINT64  | 0x07  | 8            | 64-bits unsigned integer, little-endian      |
+---------+-------+--------------+----------------------------------------------+
| INT64   | 0x08  | 8            | 64-bits signed integer, little-endian        |
+---------+-------+--------------+----------------------------------------------+
| STRING  | 0x09  | N            | C string nul-terminated.                     |
|         |       |              | See :ref:`msg-string-arg`                    |
+---------+-------+--------------+----------------------------------------------+
| F32     | 0x0a  | 4            | IEEE.754 float, little-endian                |
+---------+-------+--------------+----------------------------------------------+
| F64     | 0x0b  | 8            | IEEE.754 double, little-endian               |
+---------+-------+--------------+----------------------------------------------+
| RAW     | 0x10  | N            | Raw buffer. See :ref:`msg-raw-arg`           |
+---------+-------+--------------+----------------------------------------------+

.. _msg-string-arg:

String argument description
===========================

::

   +------------------------------------------------------+
   |                         STR                          |
   +--------+----------------+-------------------+--------+
   |  0x09  |      SIZE      |       STR[]       |  0x00  |
   +--------+----------------+-------------------+--------+
   0        1                3                 3+N      4+N

+---------+--------------+------------------------------------------------------+
| Name    | Size (bytes) | Description                                          |
+=========+==============+======================================================+
| 0x09    | 1            | The string type.                                     |
+---------+--------------+------------------------------------------------------+
| SIZE    | 2            | The string size including the nul-character.         |
|         |              | Little-endian encoded.                               |
+---------+--------------+------------------------------------------------------+
| STR[]   | N            | The string data.                                     |
+---------+--------------+------------------------------------------------------+
| 0x00    | 1            | The nul-character                                    |
+---------+--------------+------------------------------------------------------+


.. _msg-raw-arg:

Raw argument description
========================

::

   +------------------------------------------+
   |                   RAW                    |
   +--------+----------------+----------------+
   |  0x10  |      SIZE      |     DATA[]     |
   +--------+----------------+----------------+
   0        1                3              3+N

+---------+--------------+------------------------------------------------------+
| Name    | Size (bytes) | Description                                          |
+=========+==============+======================================================+
| 0x10    | 1            | The raw type.                                        |
+---------+--------------+------------------------------------------------------+
| SIZE    | 2            | The raw data size.                                   |
|         |              | Little-endian encoded.                               |
+---------+--------------+------------------------------------------------------+
| DATA[]  | N            | The raw data.                                        |
+---------+--------------+------------------------------------------------------+
